var scheme          = "<%= @scheme %>";
var uri             = scheme + window.document.location.host + "/";
var ws              = new WebSocket(uri);
var video           = document.getElementById("video-stream");
var videoSrc        = null; //video.currentSrc;
var decisionTime    = 20;
var decicsionActive = false;
// Only Testing
var videoSrcA       = "<%= @video_link_a %>";
var videoSrcB       = "<%= @video_link_b %>";

ws.onmessage = function(message) {
  var data = JSON.parse(message.data);

  if (data.decision == 'active') {
    showDecision();
  } else if (data.decided) {
    // TODO: split js files: one for movie, one for app
    if (video) {
      // Only Testing
      if (data.decided == 'A') {
        videoSrc = videoSrcA;
      } else {
        videoSrc = videoSrcB;
      }
      // videoSrc = video.currentSrc.slice(0,-4).concat(data.decided).concat('.mp4');
    }
  }
};

$("#video-stream").on("timeupdate", function() {
    // TODO: Just calculate that once
    var decicsionTime = this.duration - decisionTime;

    if (this.currentTime > decicsionTime && decicsionActive == false) {
      $("#decision-logo").fadeIn( 3000 );
      ws.send(JSON.stringify({ decision: 'active' }));
      decicsionActive = true;
    }
});

$("#video-stream").on("ended", function() {
  if (videoSrc) {
    var source = document.querySelectorAll("#video-player video source");
    source[0].src = videoSrc;
    video.load();
    video.play();
    $("#decision-logo ").hide();
    videoSrc = null;
  } else {
    $("#decision-logo").html('The End');
    $("#decision-logo").fadeIn( 3000 );
  }
});

function showDecision() {
  $("#waiting-panel").hide();
  $("#decision-panel").show();
}

function handleDecision(e) {
  ws.send(JSON.stringify({ decided: e }));
  $("#decision-panel").delay( 500 ).fadeOut( 500 );
  $("#waiting-panel").delay( 1000 ).fadeIn( 500 );
};

$(document).ready(function() {
  $("#decision-logo ").hide();
});
